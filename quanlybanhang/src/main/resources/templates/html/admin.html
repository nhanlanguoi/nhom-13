<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý</title>
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* --- Các style cơ bản đã có --- */
    .product-list-container { padding: 20px; }
    .product-item { background-color: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    .product-item h4 { margin: 0; }
    .edit-form-container { background-color: #f9f9f9; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .edit-form-container h3 { margin-top: 0; color: #333; }
    .edit-form-container label { display: block; margin-top: 12px; margin-bottom: 6px; font-weight: bold; color: #555; }
    .edit-form-container input[type="text"],
    .edit-form-container input[type="number"],
    .edit-form-container textarea {
      width: calc(100% - 22px); /* Để padding không làm vỡ layout */
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .edit-form-container textarea { min-height: 80px; }
    .edit-form-container .form-actions { margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn-edit, .btn-save, .btn-cancel { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background-color 0.2s; }
    .btn-edit { background-color: #007bff; color: white; }
    .btn-edit:hover { background-color: #0056b3; }
    .btn-save { background-color: #28a745; color: white; }
    .btn-save:hover { background-color: #1e7e34; }
    .btn-cancel { background-color: #6c757d; color: white; text-decoration: none; display: inline-block; text-align: center; line-height: normal; } /* Sửa cho nút Hủy */
    .btn-cancel:hover { background-color: #545b62; }

    .variant-section { border: 1px solid #e0e0e0; padding: 15px; margin-top: 15px; margin-bottom: 15px; border-radius: 6px; background-color: #fff; }
    .variant-section h5 { margin-top: 0; color: #D70018; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 15px; }
    .colorprice-section { border: 1px dashed #ced4da; padding: 12px; margin-top: 10px; margin-bottom: 10px; border-radius: 4px; background-color: #fdfdfd; }
    .colorprice-section h6 { margin-top: 0; margin-bottom: 10px; font-size: 0.95em; color: #495057;}

    .field-group { margin-bottom: 10px; } /* Thêm để nhóm label và input */
    .alert { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }
    .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }

    /* Style cho các nút thêm/xóa động (nếu bạn muốn làm sau) */
    .btn-add, .btn-remove {
        padding: 5px 10px;
        font-size: 0.9em;
        margin-left: 10px;
        border-radius: 4px;
        cursor: pointer;
    }
    .btn-add { background-color: #17a2b8; color: white; border: none; }
    .btn-remove { background-color: #dc3545; color: white; border: none; }
  </style>
</head>
<body>
<div class="dashboard-container">
  <aside class="sidebar">
    <div class="sidebar-header">
      <a href="/" class="logo-link"><img src="/images/logo-cps.png" alt="Logo" class="logo-img" style="max-width: 150px; height: auto;"/></a>
    </div>
    <nav class="sidebar-nav">
      <button class="nav-button active" data-target="chinh-sua-san-pham">
        <i class="fas fa-edit"></i> Chỉnh sửa sản phẩm
      </button>
      <button class="nav-button" data-target="them-san-pham">
        <i class="fas fa-plus-square"></i> Thêm sản phẩm
      </button>
    </nav>
    <div class="sidebar-footer">
      <p>&copy; <span id="currentYear"></span> CellphoneS</p>
    </div>
  </aside>

  <main class="main-content">
    <header class="main-header">
      <div class="search-bar" style="visibility: hidden;"> <i class="fas fa-search"></i>
        <input type="text" placeholder="Tìm kiếm...">
      </div>
      <div class="user-profile">
        <i class="fas fa-bell notification-icon"></i>
        <img src="https://via.placeholder.com/40" alt="User Avatar" class="avatar">
        <span>Admin</span>
        <a href="/logout" style="margin-left: 15px; color: #D70018; text-decoration: none;"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
      </div>
    </header>

    <section id="chinh-sua-san-pham" class="content-section active">
      <h1>Chỉnh sửa sản phẩm</h1>

      <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
      <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

      <div class="product-list-container card" style="background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07);">
        <h2>Chọn sản phẩm để sửa</h2>
        <div th:if="${products != null and not #lists.isEmpty(products)}">
          <div th:each="product : ${products}" class="product-item">
            <h4 th:text="${product.name} + ' (ID: ' + ${product.id} + ')'">Tên sản phẩm (ID)</h4>
            <a th:href="@{/admin/products/edit(productId=${product.id})}" class="btn-edit">Chỉnh sửa</a>
          </div>
        </div>
        <div th:if="${products == null or #lists.isEmpty(products)}">
          <p>Không có sản phẩm nào để hiển thị.</p>
        </div>
      </div>

      <div class="edit-form-container" th:if="${productToEdit != null}" style="margin-top: 30px;">
        <h3>Chỉnh sửa: <span th:text="${productToEdit.name}" style="color: #D70018;"></span></h3>
        <form th:action="@{/admin/products/update}" th:object="${productToEdit}" method="post">
          <input type="hidden" th:field="*{id}" />

          <div class="field-group">
            <label for="name">Tên sản phẩm:</label>
            <input type="text" id="name" th:field="*{name}" required />
          </div>
          <div class="field-group">
            <label for="brand">Thương hiệu:</label>
            <input type="text" id="brand" th:field="*{brand}" required />
          </div>
          <div class="field-group">
            <label for="category">Danh mục:</label>
            <input type="text" id="category" th:field="*{category}" />
          </div>
          <div class="field-group">
            <label for="description">Mô tả:</label>
            <textarea id="description" th:field="*{description}" rows="3"></textarea>
          </div>
          <div class="field-group">
            <label for="rating">Đánh giá (0.0 - 5.0):</label>
            <input type="number" step="0.1" min="0" max="5" id="rating" th:field="*{rating}" />
          </div>
          <div class="field-group">
            <label for="tags">Tags (cách nhau bởi dấu phẩy):</label>
            <input type="text" id="tags" th:field="*{tags}" th:value="${#strings.listJoin(productToEdit.tags, ',')}" />
          </div>


          <h4>Các phiên bản (Variants):
          </h4>
          <div id="variants-container">
            <div th:each="variant, variantStat : *{variants}" class="variant-section">
              <input type="hidden" th:name="'variants[' + ${variantStat.index} + '].id'" th:value="${variant.id}" />
              <h5>Phiên bản <span th:text="${variantStat.index + 1}"></span>
              </h5>
              <div class="field-group">
                <label th:for="'variant-storage-' + ${variantStat.index}">Bộ nhớ (Storage):</label>
                <input type="text" th:id="'variant-storage-' + ${variantStat.index}" th:name="'variants[' + ${variantStat.index} + '].storage'" th:value="${variant.storage}" />
              </div>
              <div class="field-group">
                <label th:for="'variant-ram-' + ${variantStat.index}">RAM:</label>
                <input type="text" th:id="'variant-ram-' + ${variantStat.index}" th:name="'variants[' + ${variantStat.index} + '].ram'" th:value="${variant.ram}" />
              </div>
              <div class="field-group">
                <label th:for="'variant-memory-' + ${variantStat.index}">Bộ nhớ trong (Memory):</label>
                <input type="text" th:id="'variant-memory-' + ${variantStat.index}" th:name="'variants[' + ${variantStat.index} + '].memory'" th:value="${variant.memory}" />
              </div>
              <div class="field-group"><label th:for="'variant-screen-' + ${variantStat.index}">Màn hình:</label><input type="text" th:id="'variant-screen-' + ${variantStat.index}" th:name="'variants[' + ${variantStat.index} + '].screen'" th:value="${variant.screen}" /></div>
              <div class="field-group"><label th:for="'variant-chip-' + ${variantStat.index}">Chip:</label><input type="text" th:id="'variant-chip-' + ${variantStat.index}" th:name="'variants[' + ${variantStat.index} + '].chip'" th:value="${variant.chip}" /></div>
              <div class="field-group"><label th:for="'variant-camera_end-' + ${variantStat.index}">Camera sau:</label><input type="text" th:id="'variant-camera_end-' + ${variantStat.index}" th:name="'variants[' + ${variantStat.index} + '].camera_end'" th:value="${variant.camera_end}" /></div>
              <div class="field-group"><label th:for="'variant-camera_start-' + ${variantStat.index}">Camera trước:</label><input type="text" th:id="'variant-camera_start-' + ${variantStat.index}" th:name="'variants[' + ${variantStat.index} + '].camera_start'" th:value="${variant.camera_start}" /></div>
              <div class="field-group"><label th:for="'variant-pin-' + ${variantStat.index}">Pin:</label><input type="text" th:id="'variant-pin-' + ${variantStat.index}" th:name="'variants[' + ${variantStat.index} + '].pin'" th:value="${variant.pin}" /></div>
              <div class="field-group"><label th:for="'variant-power-' + ${variantStat.index}">Sạc (Power):</label><input type="text" th:id="'variant-power-' + ${variantStat.index}" th:name="'variants[' + ${variantStat.index} + '].power'" th:value="${variant.power}" /></div>

              <h6>Màu sắc & Giá:
              </h6>
              <div th:id="'colorprices-container-' + ${variantStat.index}">
                <div th:each="cp, cpStat : ${variant.colorprices}" class="colorprice-section">
                  <input type="hidden" th:name="'variants[' + ${variantStat.index} + '].colorprices[' + ${cpStat.index} + '].id'" th:value="${cp.id}" />
                  <div class="field-group">
                    <label th:for="'cp-color-' + ${variantStat.index} + '-' + ${cpStat.index}">Màu:</label>
                    <input type="text" th:id="'cp-color-' + ${variantStat.index} + '-' + ${cpStat.index}" th:name="'variants[' + ${variantStat.index} + '].colorprices[' + ${cpStat.index} + '].color'" th:value="${cp.color}" />
                  </div>
                  <div class="field-group">
                    <label th:for="'cp-price-' + ${variantStat.index} + '-' + ${cpStat.index}">Giá (số nguyên, không dấu chấm):</label>
                    <input type="text" th:id="'cp-price-' + ${variantStat.index} + '-' + ${cpStat.index}" th:name="'variants[' + ${variantStat.index} + '].colorprices[' + ${cpStat.index} + '].price'" th:value="${cp.price}" />
                  </div>
                  <div class="field-group">
                    <label th:for="'cp-discount-' + ${variantStat.index} + '-' + ${cpStat.index}">Giảm giá (%):</label>
                    <input type="number" th:id="'cp-discount-' + ${variantStat.index} + '-' + ${cpStat.index}" th:name="'variants[' + ${variantStat.index} + '].colorprices[' + ${cpStat.index} + '].discount'" th:value="${cp.discount}" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-save">Lưu thay đổi</button>
            <a th:href="@{/admin/products/edit}" class="btn-cancel">Hủy</a>
          </div>
        </form>
      </div>
    </section>

    <section id="them-san-pham" class="content-section">
      <h1>Thêm sản phẩm mới</h1>
      <p>Tính năng này sẽ được phát triển sau.</p>
    </section>
  </main>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const navButtons = document.querySelectorAll('.sidebar-nav .nav-button');
      const contentSections = document.querySelectorAll('.main-content .content-section');
      const currentYearSpan = document.getElementById('currentYear');

      if (currentYearSpan) {
          currentYearSpan.textContent = new Date().getFullYear();
      }

      navButtons.forEach(button => {
          button.addEventListener('click', function() {
              navButtons.forEach(btn => btn.classList.remove('active'));
              contentSections.forEach(section => section.classList.remove('active'));

              this.classList.add('active');
              const targetSectionId = this.getAttribute('data-target');
              const targetSection = document.getElementById(targetSectionId);
              if (targetSection) {
                  targetSection.classList.add('active');
              }
          });
      });


      function addVariant() {
          const variantsContainer = document.getElementById('variants-container');
          const variantIndex = variantsContainer.querySelectorAll('.variant-section').length;
          const newVariantHtml = `
              <div class="variant-section" id="variant-${variantIndex}">
                  <input type="hidden" name="variants[${variantIndex}].id" value="" /> <h5>Phiên bản ${variantIndex + 1} <button type="button" class="btn-remove" onclick="removeVariant(${variantIndex})">Xóa phiên bản</button></h5>
                  <div class="field-group"><label>Ảnh (URL):</label><input type="text" name="variants[${variantIndex}].image" /></div>
                  <div class="field-group"><label>Bộ nhớ (Storage):</label><input type="text" name="variants[${variantIndex}].storage" /></div>
                  <div class="field-group"><label>RAM:</label><input type="text" name="variants[${variantIndex}].ram" /></div>
                  <div class="field-group"><label>Bộ nhớ trong (Memory):</label><input type="text" name="variants[${variantIndex}].memory" /></div>
                  <div class="field-group"><label>Màn hình:</label><input type="text" name="variants[${variantIndex}].screen" /></div>
                  <div class="field-group"><label>Chip:</label><input type="text" name="variants[${variantIndex}].chip" /></div>
                  <div class="field-group"><label>Camera sau:</label><input type="text" name="variants[${variantIndex}].camera_end" /></div>
                  <div class="field-group"><label>Camera trước:</label><input type="text" name="variants[${variantIndex}].camera_start" /></div>
                  <div class="field-group"><label>Pin:</label><input type="text" name="variants[${variantIndex}].pin" /></div>
                  <div class="field-group"><label>Sạc (Power):</label><input type="text" name="variants[${variantIndex}].power" /></div>
                  <h6>Màu sắc & Giá: <button type="button" class="btn-add" onclick="addColorPrice(${variantIndex})">Thêm màu/giá</button></h6>
                  <div id="colorprices-container-${variantIndex}"></div>
              </div>
          `;
          variantsContainer.insertAdjacentHTML('beforeend', newVariantHtml);
      }

      function removeVariant(variantIndex) {
          const variantElement = document.querySelector(`#variants-container .variant-section:nth-child(${variantIndex + 1})`); // Cần selector chính xác hơn
          if (variantElement) {
              variantElement.remove();
              // Cần cập nhật lại index của các variant còn lại
          }
      }

      function addColorPrice(variantIndex) {
          const colorpricesContainer = document.getElementById(`colorprices-container-${variantIndex}`);
          const cpIndex = colorpricesContainer.querySelectorAll('.colorprice-section').length;
          const newColorPriceHtml = `
              <div class="colorprice-section">
                  <input type="hidden" name="variants[${variantIndex}].colorprices[${cpIndex}].id" value="" />
                  <div class="field-group"><label>Màu:</label><input type="text" name="variants[${variantIndex}].colorprices[${cpIndex}].color" /></div>
                  <div class="field-group"><label>Giá (số):</label><input type="text" name="variants[${variantIndex}].colorprices[${cpIndex}].price" /></div>
                  <div class="field-group"><label>Giảm giá (%):</label><input type="number" name="variants[${variantIndex}].colorprices[${cpIndex}].discount" /></div>
              </div>
          `;
          colorpricesContainer.insertAdjacentHTML('beforeend', newColorPriceHtml);
      }
      // Cần thêm hàm removeColorPrice và logic cập nhật index
      */
  });
</script>
</body>
</html>